# 架构设计文档

## 概述

这是一个基于Tauri的跨平台密码管理器，采用前后端分离架构。后端使用Rust实现核心业务逻辑，前端使用Vue.js 3构建用户界面。

## 架构原则

1. **安全第一**：所有敏感数据都经过加密处理
2. **本地优先**：数据首先存储在本地，GitHub同步为可选功能
3. **模块化设计**：各功能模块职责清晰，便于维护和扩展
4. **跨平台支持**：基于Tauri框架，支持Windows、macOS、Linux

## 技术栈

### 后端
- **语言**：Rust
- **框架**：Tauri
- **加密**：Argon2 + AES-256-GCM
- **异步运行时**：Tokio
- **序列化**：Serde

### 前端
- **框架**：Vue.js 3
- **语言**：TypeScript
- **构建工具**：Vite
- **UI组件**：Element Plus

## 核心模块

### 1. 加密服务（crypto.rs）

负责所有加密相关操作：

- **MasterKey**：主密钥管理，使用Argon2从主密码派生
- **CryptoService**：提供加密/解密服务
  - 主密钥加密：用于密码等敏感数据
  - 简单密钥加密：用于描述等非敏感数据
  - 密码生成器：生成随机密码

```rust
pub struct MasterKey {
    key: Vec<u8>,
}

pub struct CryptoService {
    master_key: MasterKey,
    simple_key: Key<Aes256Gcm>,
}
```

### 2. 配置管理（config.rs）

管理应用配置：

- **安全设置**：双重加密、密码复杂度
- **存储配置**：本地路径、GitHub仓库信息
- **同步设置**：自动同步、分支配置

### 3. 密码管理器（manager.rs）

核心业务逻辑：

- **密码管理**：添加、删除、搜索密码
- **缓存管理**：内存中的密码缓存
- **数据同步**：本地与GitHub存储的同步
- **加密解密**：调用CryptoService处理数据

### 4. 存储抽象（store.rs）

定义存储接口：

```rust
#[async_trait]
pub trait Storage: Send + Sync {
    async fn load(&self) -> Result<StorageData>;
    async fn save(&self, data: &StorageData) -> Result<()>;
    async fn test_connection(&self) -> Result<()>;
}
```

### 5. 具体存储实现

- **LocalStore**：本地JSON文件存储
- **GithubStore**：GitHub仓库存储，使用GitHub API

### 6. GitHub客户端（github_client.rs）

封装GitHub API操作：

- 文件读写
- 分支管理
- 提交创建

## 数据流

### 密码添加流程

1. 用户输入密码信息
2. 前端调用Tauri命令
3. 后端验证主密码
4. 使用CryptoService加密密码
5. 创建Password对象
6. 更新内存缓存
7. 保存到本地存储
8. 同步到GitHub（如配置）

### 密码搜索流程

1. 用户在搜索框输入查询
2. 前端调用搜索API
3. 后端在内存缓存中搜索
4. 返回匹配的密码列表
5. 前端展示结果

### 数据同步流程

1. 应用启动时加载数据
2. 优先从本地存储加载
3. 尝试从GitHub加载（如配置）
4. 比较时间戳，选择最新数据
5. 更新内存缓存
6. 如有冲突，解决并保存

## 安全设计

### 1. 密钥管理

- 主密码使用Argon2派生密钥
- 密钥从不存储，只存在于内存中
- 使用盐值增加安全性

### 2. 数据加密

- 密码使用主密钥加密（AES-256-GCM）
- 描述可选择双重加密
- 每个加密操作使用独立的nonce

### 3. 存储安全

- 本地存储文件加密保存
- GitHub存储同样使用加密数据
- 不存储任何明文密码

### 4. 内存安全

- 敏感数据使用后及时清理
- 使用Rust的内存安全特性
- 避免缓冲区溢出等漏洞

## 错误处理

### 1. 加密错误

- 密钥派生失败
- 加密/解密失败
- 数据损坏检测

### 2. 存储错误

- 文件读写失败
- GitHub API错误
- 网络连接问题

### 3. 同步错误

- 冲突解决失败
- 版本不兼容
- 权限问题

## 扩展性

### 1. 存储后端

可以轻松添加新的存储后端：

- Dropbox存储
- Google Drive存储
- 自定义服务器存储

### 2. 加密算法

支持更换加密算法：

- ChaCha20-Poly1305
- XChaCha20-Poly1305
- 自定义加密方案

### 3. 导入导出

支持多种格式：

- CSV导入/导出
- JSON备份
- 其他密码管理器格式

## 性能优化

### 1. 缓存策略

- 内存缓存减少磁盘I/O
- 延迟加载非关键数据
- 批量操作减少API调用

### 2. 加密优化

- 复用CryptoService实例
- 合理的密钥长度选择
- 异步加密避免阻塞

### 3. 存储优化

- 增量同步减少数据传输
- 压缩减少存储空间
- 索引加速搜索

## 监控和调试

### 1. 日志记录

- 关键操作日志
- 错误详细信息
- 性能指标收集

### 2. 调试支持

- 开发模式详细日志
- 测试覆盖率
- 性能分析工具

## 部署考虑

### 1. 跨平台兼容性

- 不同操作系统的路径处理
- 文件权限管理
- 系统托盘集成

### 2. 自动更新

- Tauri内置更新机制
- GitHub Releases集成
- 增量更新支持

### 3. 用户数据迁移

- 版本升级数据兼容
- 备份恢复机制
- 导入导出支持